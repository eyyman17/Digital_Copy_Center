{% extends 'dir_base.html' %}

{% block title %}Liste des Professeurs{% endblock %}

{% block content %}
<h1>Liste des Professeurs</h1>

<div class="card mb-3">
    <div class="card-body">
        <div class="input-group">
            <input
                type="text"
                id="professorSearch"
                class="form-control mr-3"
                placeholder="Entrer le nom de professeur..."
                autocomplete="off"
            />
            <div class="ms-1">
                <button class="btn btn-primary" type="button">Rechercher</button>
                <a href="{% url 'direction:professor_list' %}" class="btn btn-secondary">Réinitialiser</a>
            </div>
        </div>
        <!-- Suggestions will be displayed here -->
        <ul id="suggestions" class="list-group position-absolute" style="z-index: 1000; display: none; max-height: 200px; overflow-y: auto;"></ul>
    </div>
</div>

<style>
    /* Table Styling */
    table.table {
        border-collapse: collapse;
        width: 100%;
    }

    table.table th, table.table td {
        text-align: center; /* Center text in cells */
        vertical-align: middle; /* Vertically align text */
        padding: 10px; /* Add spacing inside cells */
    }

    /* Table Header Styling */
    table.table thead th {
        background-color: #f8f9fa; /* Light gray for header background */
        font-weight: bold;
        text-transform: uppercase;
        border-bottom: 2px solid #dee2e6; /* Add bottom border */
    }

    /* Alternating Row Colors */
    table.table tbody tr:nth-child(even) {
        background-color: #f8f9fa; /* Light gray for even rows */
    }
    table.table tbody tr:nth-child(odd) {
        background-color: #ffffff; /* White for odd rows */
    }
</style>

<table class="table table-bordered">
    <thead>
        <tr>
            <th style="width: 5%;">#</th>
            <th style="width: 35%;">Nom Complet</th>
            <th style="width: 40%;">Email</th>
            <th style="width: 20%;">Suppression</th>
        </tr>
    </thead>
    <tbody>
        {% for professor in professors %}
        <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ professor.get_full_name }}</td>
            <td>{{ professor.email }}</td>
            <td>
                <button 
                    class="btn btn-danger btn-sm delete-button" 
                    data-professor-id="{{ professor.id }}" 
                    data-professor-name="{{ professor.get_full_name }}">
                    Supprimer
                </button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Bootstrap Modal for Delete Confirmation -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmationModalLabel">Confirmer la suppression</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                Êtes-vous sûr de vouloir supprimer <strong id="professorName"></strong> ?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" id="confirmDeleteButton" class="btn btn-danger">Supprimer</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const searchInput = document.getElementById("professorSearch");
        const suggestionsBox = document.getElementById("suggestions");
        const searchButton = document.querySelector(".btn-primary");
        const tableBody = document.querySelector("table tbody");
        const deleteModal = new bootstrap.Modal(document.getElementById("deleteConfirmationModal"));
        const confirmDeleteButton = document.getElementById("confirmDeleteButton");
        let professorIdToDelete = null;

        // Event listener for search input to display suggestions
        searchInput.addEventListener("input", function () {
            const query = this.value;

            if (!query) {
                suggestionsBox.style.display = "none";
                return;
            }

            fetch(`/direction/search_professor/?q=${encodeURIComponent(query)}`)
                .then((response) => response.json())
                .then((data) => {
                    suggestionsBox.innerHTML = "";

                    if (data.length > 0) {
                        suggestionsBox.style.display = "block";
                        data.forEach((professor) => {
                            const suggestionItem = document.createElement("li");
                            suggestionItem.classList.add("list-group-item", "list-group-item-action");
                            suggestionItem.textContent = `${professor.first_name} ${professor.last_name} (${professor.email})`;

                            // Populate search input with professor email on selection
                            suggestionItem.addEventListener("click", function () {
                                searchInput.value = professor.email; // Use email as unique identifier
                                suggestionsBox.style.display = "none";
                            });

                            suggestionsBox.appendChild(suggestionItem);
                        });
                    } else {
                        suggestionsBox.style.display = "none";
                    }
                })
                .catch((error) => {
                    console.error("Erreur lors de la récupération des suggestions de professeur :", error);
                    suggestionsBox.style.display = "none";
                });
        });

        // Event listener for the "Rechercher" button
        searchButton.addEventListener("click", function () {
            const query = searchInput.value;

            if (!query) {
                alert("Veuillez entrer un nom de professeur pour effectuer une recherche.");
                return;
            }

            fetch(`/direction/search_professor/?q=${encodeURIComponent(query)}`)
                .then((response) => response.json())
                .then((data) => {
                    tableBody.innerHTML = ""; // Clear the existing table rows

                    if (data.length > 0) {
                        data.forEach((professor, index) => {
                            const row = document.createElement("tr");
                            row.innerHTML = `
                                <td>${index + 1}</td>
                                <td>${professor.first_name} ${professor.last_name}</td>
                                <td>${professor.email}</td>
                                <td>
                                    <button 
                                        class="btn btn-danger btn-sm delete-button" 
                                        data-professor-id="${professor.id}" 
                                        data-professor-name="${professor.first_name} ${professor.last_name}">
                                        Supprimer
                                    </button>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });
                    } else {
                        const row = document.createElement("tr");
                        row.innerHTML = `<td colspan="4" class="text-center">Aucun professeur trouvé.</td>`;
                        tableBody.appendChild(row);
                    }
                })
                .catch((error) => {
                    console.error("Erreur lors de la récupération des résultats de recherche :", error);
                });
        });

        // Handle delete button clicks
        tableBody.addEventListener("click", function (e) {
            if (e.target.classList.contains("delete-button")) {
                const button = e.target;
                const professorName = button.dataset.professorName;
                professorIdToDelete = button.dataset.professorId;

                // Set the professor's name in the modal
                document.getElementById("professorName").textContent = professorName;

                // Show the modal
                deleteModal.show();
            }
        });

        // Handle the confirm delete button click
        confirmDeleteButton.addEventListener("click", function () {
            if (professorIdToDelete) {
                fetch(`/direction/delete_professor/${professorIdToDelete}/`, {
                    method: "DELETE",
                    headers: {
                        "X-Requested-With": "XMLHttpRequest",
                        "Content-Type": "application/json",
                        "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                })
                    .then((response) => {
                        if (response.ok) {
                            // Remove the corresponding table row
                            const row = document.querySelector(`button[data-professor-id="${professorIdToDelete}"]`).closest("tr");
                            row.remove();
                            alert("Professeur supprimé avec succès.");
                        } else {
                            alert("Échec de la suppression du professeur. Veuillez réessayer.");
                        }
                    })
                    .catch((error) => {
                        console.error("Erreur lors de la suppression du professeur :", error);
                        alert("Une erreur s'est produite. Veuillez réessayer.");
                    })
                    .finally(() => {
                        deleteModal.hide();
                    });
            }
        });

        // Hide suggestions when clicking outside
        document.addEventListener("click", function (e) {
            if (!searchInput.contains(e.target) && !suggestionsBox.contains(e.target)) {
                suggestionsBox.style.display = "none";
            }
        });
    });
</script>

{% endblock %}